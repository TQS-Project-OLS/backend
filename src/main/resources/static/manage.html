<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage - OLSHEETS</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="js/theme.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/nav.js"></script>
</head>

<body>
    <!-- Nav injected by js/nav.js -->
    <script>
        requireAuth();
    </script>

    <div class="container">
        <div class="page-header">
            <h1>Manage Inventory</h1>
            <p style="color: var(--text-muted);">Update prices and set unavailability periods</p>
        </div>

        <div class="card">
            <h2 style="margin-bottom: var(--space-lg);">My Instruments</h2>

            <div id="instruments-list">
                <!-- Instrument items injected here -->
            </div>
        </div>

        <!-- Incoming Booking Requests Section -->
        <div class="card" style="margin-top: var(--space-xl);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg);">
                <h2>Incoming Booking Requests</h2>
                <button class="btn btn-secondary" onclick="loadIncomingBookings()">Refresh</button>
            </div>

            <div id="incoming-bookings-list">
                <!-- Booking requests injected here -->
            </div>
        </div>

    </div>

    <!-- Management Modal -->
    <div class="modal-overlay" id="manage-modal">
        <div class="modal">
            <h2 id="modal-title" style="margin-bottom: var(--space-md);">Manage Instrument</h2>
            <input type="hidden" id="manage-instrument-id">

            <!-- Tabs in Modal -->
            <div class="tabs" style="margin-bottom: var(--space-lg); justify-content: flex-start;">
                <button class="tab active" onclick="switchModalTab('price')">Update Price</button>
                <button class="tab" onclick="switchModalTab('availability')">Availability</button>
            </div>

            <!-- Price Tab -->
            <div id="modal-content-price">
                <div class="form-group">
                    <label class="form-label">New Price ($)</label>
                    <input type="number" step="0.01" class="form-control" id="new-price-input">
                </div>
                <button class="btn btn-primary" onclick="updatePrice()">Save Price</button>
            </div>

            <!-- Availability Tab -->
            <div id="modal-content-availability" class="hidden">
                <div class="form-group">
                    <label class="form-label">Reason</label>
                    <select class="form-control" id="unavail-reason">
                        <option value="MAINTENANCE">Maintenance</option>
                        <option value="OWNER_USE">Owner Use</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="unavail-start">
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="unavail-end">
                </div>
                <button class="btn btn-primary" onclick="createUnavailability()">Block Dates</button>

                <div style="margin-top: var(--space-lg);">
                    <h4>Current Blocks</h4>
                    <ul id="availability-list" style="list-style: none; padding: 0; margin-top: var(--space-sm);">
                        <!-- List -->
                    </ul>
                </div>
            </div>

            <button class="btn btn-secondary" style="margin-top: var(--space-lg); width: 100%;"
                onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        // Use legacy search endpoint for now as there isn't a direct "get by owner" endpoint exposed in ProductsController clearly,
        // mimicking discovery but for management.
        // Actually, we can use search by name empty or filter to get list, then filter by owner in client if needed.
        // Load the current user's instruments on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadOwnerInstruments();
            loadIncomingBookings();
        });

        async function loadOwnerInstruments() {
            const list = document.getElementById('instruments-list');
            list.innerHTML = 'Loading...';

            try {
                // Fetch instruments owned by the authenticated user
                const response = await authenticatedFetch('/api/instruments/my-instruments');
                const myInstruments = await response.json();

                displayInstruments(myInstruments);

            } catch (error) {
                console.error(error);
                list.innerHTML = '<p style="color: var(--error);">Error loading instruments. Please try again.</p>';
            }
        }

        function displayInstruments(instruments) {
            const list = document.getElementById('instruments-list');
            if (instruments.length === 0) {
                list.innerHTML = '<p>No instruments found. <a href="rent-up.html">Upload your first instrument</a>!</p>';
                return;
            }

            list.innerHTML = instruments.map(i => `
                <div class="card" style="margin-bottom: var(--space-md); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3>${i.name}</h3>
                        <p style="color: var(--text-muted);">$${i.price} / day</p>
                    </div>
                    <button class="btn btn-secondary" onclick="openManageModal(${i.id}, '${i.name}', ${i.price})">Manage</button>
                </div>
             `).join('');
        }

        function openManageModal(id, name, price) {
            document.getElementById('manage-instrument-id').value = id;
            document.getElementById('modal-title').textContent = `Manage: ${name}`;
            document.getElementById('new-price-input').value = price;

            // Reset tab
            switchModalTab('price');
            loadAvailabilities(id);

            const modal = document.getElementById('manage-modal');
            modal.classList.add('open');
        }

        function closeModal() {
            document.getElementById('manage-modal').classList.remove('open');
        }

        function switchModalTab(tab) {
            const priceContent = document.getElementById('modal-content-price');
            const availContent = document.getElementById('modal-content-availability');
            const buttons = document.querySelectorAll('#manage-modal .tab');

            if (tab === 'price') {
                priceContent.classList.remove('hidden');
                availContent.classList.add('hidden');
                buttons[0].classList.add('active');
                buttons[1].classList.remove('active');
            } else {
                priceContent.classList.add('hidden');
                availContent.classList.remove('hidden');
                buttons[0].classList.remove('active');
                buttons[1].classList.add('active');
            }
        }

        async function updatePrice() {
            const id = document.getElementById('manage-instrument-id').value;
            const price = document.getElementById('new-price-input').value;

            try {
                const response = await authenticatedFetch(`/api/items/price/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPrice: parseFloat(price) })
                });

                if (response.ok) {
                    alert('Price updated!');
                    loadOwnerInstruments(); // Refresh list
                } else {
                    alert('Failed to update price');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function createUnavailability() {
            const id = document.getElementById('manage-instrument-id').value;
            const start = document.getElementById('unavail-start').value;
            const end = document.getElementById('unavail-end').value;
            const reason = document.getElementById('unavail-reason').value;

            if (!start || !end) return alert('Select dates');

            try {
                const response = await authenticatedFetch(`/api/availability?instrumentId=${id}&startDate=${start}&endDate=${end}&reason=${reason}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    loadAvailabilities(id); // Refresh list
                    document.getElementById('unavail-start').value = '';
                    document.getElementById('unavail-end').value = '';
                } else {
                    const data = await response.json();
                    alert('Failed: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadAvailabilities(id) {
            const list = document.getElementById('availability-list');
            list.innerHTML = 'Loading...';

            try {
                const response = await authenticatedFetch(`/api/availability/instrument/${id}`);
                const data = await response.json();

                if (data.length === 0) {
                    list.innerHTML = '<li>No blocks set.</li>';
                    return;
                }

                list.innerHTML = data.map(period => `
                    <li style="background: var(--surface-hover); padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-sm); margin-bottom: var(--space-xs); display: flex; justify-content: space-between; align-items: center;">
                        <span>${period.startDate} to ${period.endDate} (${period.reason})</span>
                        <button class="btn btn-danger" style="padding: 2px 6px; font-size: 0.8rem;" onclick="deleteUnavailability(${period.id}, ${id})">x</button>
                    </li>
                `).join('');
            } catch (e) {
                list.innerHTML = 'Error loading availability';
            }
        }

        async function deleteUnavailability(availId, instrumentId) {
            if (!confirm('Delete this block?')) return;
            try {
                const response = await authenticatedFetch(`/api/availability/${availId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAvailabilities(instrumentId);
                } else {
                    alert('Failed to delete');
                }
            } catch (e) {
                alert('Error');
            }
        }

        async function loadIncomingBookings() {
            const list = document.getElementById('incoming-bookings-list');
            list.innerHTML = 'Loading...';

            try {
                // Fetch bookings for instruments owned by the authenticated user
                const response = await authenticatedFetch('/api/bookings/my-instrument-bookings');
                const bookings = await response.json();

                displayIncomingBookings(bookings);

            } catch (error) {
                console.error(error);
                list.innerHTML = '<p style="color: var(--error);">Error loading incoming bookings. Please try again.</p>';
            }
        }

        function displayIncomingBookings(bookings) {
            const list = document.getElementById('incoming-bookings-list');
            
            if (bookings.length === 0) {
                list.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: var(--space-md);">No incoming booking requests yet.</p>';
                return;
            }

            list.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: var(--space-sm);">
                    <thead>
                        <tr style="background: var(--surface-hover); text-align: left;">
                            <th style="padding: var(--space-sm);">Renter</th>
                            <th style="padding: var(--space-sm);">Instrument</th>
                            <th style="padding: var(--space-sm);">Dates</th>
                            <th style="padding: var(--space-sm);">Status</th>
                            <th style="padding: var(--space-sm);">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${bookings.map(booking => {
                            const statusClass = booking.status === 'APPROVED' ? 'success' : 
                                              booking.status === 'REJECTED' ? 'error' : 
                                              booking.status === 'PAID' ? 'info' : 'warning';
                            
                            const isPending = booking.status === 'PENDING';
                            
                            return `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: var(--space-sm);">${booking.renter.name} (${booking.renter.username})</td>
                                    <td style="padding: var(--space-sm);">${booking.item.name}</td>
                                    <td style="padding: var(--space-sm);">${booking.startDate} to ${booking.endDate}</td>
                                    <td style="padding: var(--space-sm);">
                                        <span style="padding: 2px 8px; border-radius: var(--radius-sm); background: var(--${statusClass}); color: white; font-size: 0.85rem;">
                                            ${booking.status}
                                        </span>
                                    </td>
                                    <td style="padding: var(--space-sm);">
                                        ${isPending ? `
                                            <button class="btn btn-success" style="padding: 4px 12px; font-size: 0.85rem; margin-right: 4px;" 
                                                onclick="processIncomingBooking(${booking.id}, 'approve')">
                                                Approve
                                            </button>
                                            <button class="btn btn-danger" style="padding: 4px 12px; font-size: 0.85rem;" 
                                                onclick="processIncomingBooking(${booking.id}, 'reject')">
                                                Reject
                                            </button>
                                        ` : '-'}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        async function processIncomingBooking(bookingId, action) {
            const actionText = action === 'approve' ? 'approve' : 'reject';
            if (!confirm(`Are you sure you want to ${actionText} this booking?`)) return;

            try {
                const response = await authenticatedFetch(`/api/bookings/${bookingId}/${action}`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    alert(`Booking ${actionText}d successfully!`);
                    loadIncomingBookings(); // Refresh the list
                } else {
                    const errorData = await response.json();
                    alert(`Failed to ${actionText} booking: ${errorData.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error(error);
                alert(`Error ${actionText}ing booking. Please try again.`);
            }
        }

        // Initial load
        loadOwnerInstruments();
    </script>
</body>

</html>
