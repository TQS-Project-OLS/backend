<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage - OLSHEETS</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="js/theme.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/nav.js"></script>
</head>

<body>
    <!-- Nav injected by js/nav.js -->
    <script>
        requireAuth();
    </script>

    <div class="container">
        <div class="page-header">
            <h1>Manage Inventory</h1>
            <p style="color: var(--text-muted);">Update prices and set unavailability periods</p>
        </div>

        <div class="card">
            <h2 style="margin-bottom: var(--space-lg);">My Instruments</h2>

            <div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-lg);">
                <input type="text" id="owner-id-input" class="form-control" placeholder="Enter Owner ID (e.g. 1)"
                    value="1">
                <button class="btn btn-primary" onclick="loadOwnerInstruments()">Load</button>
            </div>

            <div id="instruments-list">
                <!-- Instrument items injected here -->
            </div>
        </div>

    </div>

    <!-- Management Modal -->
    <div class="modal-overlay" id="manage-modal">
        <div class="modal">
            <h2 id="modal-title" style="margin-bottom: var(--space-md);">Manage Instrument</h2>
            <input type="hidden" id="manage-instrument-id">

            <!-- Tabs in Modal -->
            <div class="tabs" style="margin-bottom: var(--space-lg); justify-content: flex-start;">
                <button class="tab active" onclick="switchModalTab('price')">Update Price</button>
                <button class="tab" onclick="switchModalTab('availability')">Availability</button>
            </div>

            <!-- Price Tab -->
            <div id="modal-content-price">
                <div class="form-group">
                    <label class="form-label">New Price ($)</label>
                    <input type="number" step="0.01" class="form-control" id="new-price-input">
                </div>
                <button class="btn btn-primary" onclick="updatePrice()">Save Price</button>
            </div>

            <!-- Availability Tab -->
            <div id="modal-content-availability" class="hidden">
                <div class="form-group">
                    <label class="form-label">Reason</label>
                    <select class="form-control" id="unavail-reason">
                        <option value="MAINTENANCE">Maintenance</option>
                        <option value="OWNER_USE">Owner Use</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="unavail-start">
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" id="unavail-end">
                </div>
                <button class="btn btn-primary" onclick="createUnavailability()">Block Dates</button>

                <div style="margin-top: var(--space-lg);">
                    <h4>Current Blocks</h4>
                    <ul id="availability-list" style="list-style: none; padding: 0; margin-top: var(--space-sm);">
                        <!-- List -->
                    </ul>
                </div>
            </div>

            <button class="btn btn-secondary" style="margin-top: var(--space-lg); width: 100%;"
                onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        // Use legacy search endpoint for now as there isn't a direct "get by owner" endpoint exposed in ProductsController clearly,
        // mimicking discovery but for management.
        // Actually, we can use search by name empty or filter to get list, then filter by owner in client if needed.
        // For accurate testing, we really should have a proper endpoint, but I will use the search endpoint for MVP.

        async function loadOwnerInstruments() {
            const list = document.getElementById('instruments-list');
            list.innerHTML = 'Loading...';

            try {
                // Fetch all (hacky way: search with empty string or common letter)
                // Real app would have /api/instruments/owner/{id}
                const response = await authenticatedFetch('/api/instruments/search?name=');
                const allInstruments = await response.json();

                // Filter client side for now since backend might not strictly support owner filter on search
                // Assuming we just show all for the demo or if ownerId matches (if we had ownerId in response)
                // The current Instrument DTO returned might not have ownerId visible? Let's check.
                // Looking at ProductsController, it returns List<Instrument>. Instrument has ownerId.

                // For demo purpose, listing all instruments to manage
                displayInstruments(allInstruments);

            } catch (error) {
                console.error(error);
                list.innerHTML = 'Error loading instruments';
            }
        }

        function displayInstruments(instruments) {
            const list = document.getElementById('instruments-list');
            if (instruments.length === 0) {
                list.innerHTML = '<p>No instruments found.</p>';
                return;
            }

            list.innerHTML = instruments.map(i => `
                <div class="card" style="margin-bottom: var(--space-md); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3>${i.name}</h3>
                        <p style="color: var(--text-muted);">$${i.price} / day</p>
                    </div>
                    <button class="btn btn-secondary" onclick="openManageModal(${i.id}, '${i.name}', ${i.price})">Manage</button>
                </div>
             `).join('');
        }

        function openManageModal(id, name, price) {
            document.getElementById('manage-instrument-id').value = id;
            document.getElementById('modal-title').textContent = `Manage: ${name}`;
            document.getElementById('new-price-input').value = price;

            // Reset tab
            switchModalTab('price');
            loadAvailabilities(id);

            const modal = document.getElementById('manage-modal');
            modal.classList.add('open');
        }

        function closeModal() {
            document.getElementById('manage-modal').classList.remove('open');
        }

        function switchModalTab(tab) {
            const priceContent = document.getElementById('modal-content-price');
            const availContent = document.getElementById('modal-content-availability');
            const buttons = document.querySelectorAll('#manage-modal .tab');

            if (tab === 'price') {
                priceContent.classList.remove('hidden');
                availContent.classList.add('hidden');
                buttons[0].classList.add('active');
                buttons[1].classList.remove('active');
            } else {
                priceContent.classList.add('hidden');
                availContent.classList.remove('hidden');
                buttons[0].classList.remove('active');
                buttons[1].classList.add('active');
            }
        }

        async function updatePrice() {
            const id = document.getElementById('manage-instrument-id').value;
            const price = document.getElementById('new-price-input').value;

            try {
                const response = await authenticatedFetch(`/api/items/price/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPrice: parseFloat(price) })
                });

                if (response.ok) {
                    alert('Price updated!');
                    loadOwnerInstruments(); // Refresh list
                } else {
                    alert('Failed to update price');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function createUnavailability() {
            const id = document.getElementById('manage-instrument-id').value;
            const start = document.getElementById('unavail-start').value;
            const end = document.getElementById('unavail-end').value;
            const reason = document.getElementById('unavail-reason').value;

            if (!start || !end) return alert('Select dates');

            try {
                const response = await authenticatedFetch(`/api/availability?instrumentId=${id}&startDate=${start}&endDate=${end}&reason=${reason}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    loadAvailabilities(id); // Refresh list
                    document.getElementById('unavail-start').value = '';
                    document.getElementById('unavail-end').value = '';
                } else {
                    const data = await response.json();
                    alert('Failed: ' + (data.message || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadAvailabilities(id) {
            const list = document.getElementById('availability-list');
            list.innerHTML = 'Loading...';

            try {
                const response = await authenticatedFetch(`/api/availability/instrument/${id}`);
                const data = await response.json();

                if (data.length === 0) {
                    list.innerHTML = '<li>No blocks set.</li>';
                    return;
                }

                list.innerHTML = data.map(period => `
                    <li style="background: var(--surface-hover); padding: var(--space-xs) var(--space-sm); border-radius: var(--radius-sm); margin-bottom: var(--space-xs); display: flex; justify-content: space-between; align-items: center;">
                        <span>${period.startDate} to ${period.endDate} (${period.reason})</span>
                        <button class="btn btn-danger" style="padding: 2px 6px; font-size: 0.8rem;" onclick="deleteUnavailability(${period.id}, ${id})">x</button>
                    </li>
                `).join('');
            } catch (e) {
                list.innerHTML = 'Error loading availability';
            }
        }

        async function deleteUnavailability(availId, instrumentId) {
            if (!confirm('Delete this block?')) return;
            try {
                const response = await authenticatedFetch(`/api/availability/${availId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAvailabilities(instrumentId);
                } else {
                    alert('Failed to delete');
                }
            } catch (e) {
                alert('Error');
            }
        }

        // Initial load
        loadOwnerInstruments();
    </script>
</body>

</html>
