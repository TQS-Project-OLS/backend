<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <springProfile name="!docker">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%-5level) [%thread] %cyan(%logger{36}) - %msg%n</pattern>
            </encoder>
        </appender>
    </springProfile>

    <springProfile name="docker">
        <!-- JSON format for container logs -->
        <appender name="JSON_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="net.logstash.logback.encoder.LogstashEncoder"/>
        </appender>
        
        <!-- File appender for Promtail to collect -->
        <appender name="FILE" class="ch.qos.logback.core.FileAppender">
            <file>/app/logs/olsheets.log</file>
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>
        
        <!-- Loki appender for centralized logging -->
        <appender name="LOKI" class="com.github.loki4j.logback.Loki4jAppender">
            <http>
                <url>http://loki:3100/loki/api/v1/push</url>
            </http>
            <format>
                <label>
                    <pattern>app=olsheets,env=${spring.profiles.active:-prod}</pattern>
                </label>
                <message>
                    <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg%n</pattern>
                </message>
            </format>
        </appender>
        
        <root level="INFO">
            <appender-ref ref="JSON_CONSOLE" />
            <appender-ref ref="FILE" />
            <appender-ref ref="LOKI" />
        </root>
    </springProfile>

    <root level="INFO">
        <appender-ref ref="CONSOLE" />
    </root>
    
    <!-- Application-specific log levels -->
    <logger name="com.example.OLSHEETS" level="DEBUG" additivity="false">
        <appender-ref ref="CONSOLE" />
    </logger>
    
    <logger name="org.springframework.security" level="DEBUG" additivity="false">
        <appender-ref ref="CONSOLE" />
    </logger>
</configuration>