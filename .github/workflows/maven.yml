name: CI with Maven (tests + Xray)

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    strategy:
      matrix:
        java: [ '21' ]

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java }}
        distribution: 'temurin'
        cache: maven

    - name: Run Maven (unit + integration tests, generate reports)
      # ensure reports (cucumber.json + surefire/failsafe xml + jacoco xml) are produced even if tests fail
      run: mvn -B -DskipTests=false -Dmaven.test.failure.ignore=true -Dcucumber.plugin=json:target/cucumber.json verify

    - name: Collect test artifacts (for debugging)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: |
          target/cucumber.json
          target/surefire-reports/**/*.xml
          target/failsafe-reports/**/*.xml
          target/site/jacoco/jacoco.xml
          target/site/jacoco/jacoco-merged-test-coverage-report/**/*

    - name: Upload Cucumber results to Xray (cloud)
      if: always()
      uses: mikepenz/xray-action@v3
      with:
        username: ${{ secrets.XRAY_CLIENT_ID }}
        password: ${{ secrets.XRAY_CLIENT_SECRET }}
        testFormat: "cucumber"
        testPaths: "target/cucumber.json"
        testPlanKey: ${{ secrets.XRAY_TESTPLAN_KEY }}
        projectKey: "OLS"

    - name: Upload JUnit results to Xray (cloud) (non-Cucumber)
      if: always()
      uses: mikepenz/xray-action@v3
      with:
        username: ${{ secrets.XRAY_CLIENT_ID }}
        password: ${{ secrets.XRAY_CLIENT_SECRET }}
        testFormat: "junit"
        testPaths: "**/surefire-reports/TEST-*.xml,**/failsafe-reports/TEST-*.xml"
        testPlanKey: ${{ secrets.XRAY_TESTPLAN_KEY }}
        projectKey: "OLS"
